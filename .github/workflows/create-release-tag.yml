name: Create Release Tag
on:
  workflow_dispatch: {}
jobs:
  create-tag:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref,
      'release/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Extract version from branch name
      id: extract_version
      run: 'BRANCH_NAME="${{ github.event.pull_request.head.ref }}"

        VERSION="${BRANCH_NAME#release/v}"

        echo "version=$VERSION" >> $GITHUB_OUTPUT

        '
    - name: Create and push tag
      run: "git config --local user.email \"github-actions[bot]@users.noreply.github.com\"\
        \ngit config --local user.name \"github-actions[bot]\"\n\n# Create annotated\
        \ tag\ngit tag -a \"v${{ steps.extract_version.outputs.version }}\" \\\n \
        \ -m \"Release v${{ steps.extract_version.outputs.version }}\"\n\n# Push tag\n\
        git push origin \"v${{ steps.extract_version.outputs.version }}\"\n"
    - name: Create GitHub Release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: "VERSION=\"${{ steps.extract_version.outputs.version }}\"\n\n# Extract\
        \ changelog section for this version to a temp file\nawk -v ver=\"$VERSION\"\
        \ '\n  /^## / {\n    if (found) exit\n    if ($2 == ver) found=1\n    next\n\
        \  }\n  found { print }\n' CHANGELOG.md > release_notes.md\n\n# Append install\
        \ instructions\n{\n  echo \"\"\n  echo \"---\"\n  echo \"\"\n  echo \"**PyPI:**\
        \ https://pypi.org/project/claude-agent-sdk/VERSION/\"\n  echo \"\"\n  echo\
        \ '```bash'\n  echo \"pip install claude-agent-sdk==VERSION\"\n  echo '```'\n\
        } >> release_notes.md\n\n# Replace VERSION placeholder\nsed -i \"s/VERSION/$VERSION/g\"\
        \ release_notes.md\n\n# Create release with notes from file\ngh release create\
        \ \"v$VERSION\" \\\n  --title \"v$VERSION\" \\\n  --notes-file release_notes.md\n"
