name: Claude Issue Triage
on:
  workflow_dispatch: {}
jobs:
  triage-issue:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Create triage prompt
      run: "mkdir -p /tmp/claude-prompts\ncat > /tmp/claude-prompts/triage-prompt.txt\
        \ << 'EOF'\nYou're an issue triage assistant for GitHub issues. Your task\
        \ is to analyze the issue and select appropriate labels from the provided\
        \ list.\n\nIMPORTANT: Don't post any comments or messages to the issue. Your\
        \ only action should be to apply labels.\n\nIssue Information:\n- REPO: ${{\
        \ github.repository }}\n- ISSUE_NUMBER: ${{ github.event.issue.number }}\n\
        \nTASK OVERVIEW:\n\n1. First, fetch the list of labels available in this repository\
        \ by running: `gh label list`. Run exactly this command with nothing else.\n\
        \n2. Next, use the GitHub tools to get context about the issue:\n   - You\
        \ have access to these tools:\n     - mcp__github__get_issue: Use this to\
        \ retrieve the current issue's details including title, description, and existing\
        \ labels\n     - mcp__github__get_issue_comments: Use this to read any discussion\
        \ or additional context provided in the comments\n     - mcp__github__update_issue:\
        \ Use this to apply labels to the issue (do not use this for commenting)\n\
        \     - mcp__github__search_issues: Use this to find similar issues that might\
        \ provide context for proper categorization and to identify potential duplicate\
        \ issues\n     - mcp__github__list_issues: Use this to understand patterns\
        \ in how other issues are labeled\n   - Start by using mcp__github__get_issue\
        \ to get the issue details\n\n3. Analyze the issue content, considering:\n\
        \   - The issue title and description\n   - The type of issue (bug report,\
        \ feature request, question, etc.)\n   - Technical areas mentioned\n   - Severity\
        \ or priority indicators\n   - User impact\n   - Components affected\n\n4.\
        \ Select appropriate labels from the available labels list provided above:\n\
        \   - Choose labels that accurately reflect the issue's nature\n   - Be specific\
        \ but comprehensive\n   - Select priority labels if you can determine urgency\
        \ (high-priority, med-priority, or low-priority)\n   - Consider platform labels\
        \ (android, ios) if applicable\n   - If you find similar issues using mcp__github__search_issues,\
        \ consider using a \"duplicate\" label if appropriate. Only do so if the issue\
        \ is a duplicate of another OPEN issue.\n\n5. Apply the selected labels:\n\
        \   - Use mcp__github__update_issue to apply your selected labels\n   - DO\
        \ NOT post any comments explaining your decision\n   - DO NOT communicate\
        \ directly with users\n   - If no labels are clearly applicable, do not apply\
        \ any labels\n\nIMPORTANT GUIDELINES:\n- Be thorough in your analysis\n- Only\
        \ select labels from the provided list above\n- DO NOT post any comments to\
        \ the issue\n- Your ONLY action should be to apply labels using mcp__github__update_issue\n\
        - It's okay to not add any labels if none are clearly applicable\nEOF\n"
    - name: Setup GitHub MCP Server
      run: "mkdir -p /tmp/mcp-config\ncat > /tmp/mcp-config/mcp-servers.json << 'EOF'\n\
        {\n  \"mcpServers\": {\n    \"github\": {\n      \"command\": \"docker\",\n\
        \      \"args\": [\n        \"run\",\n        \"-i\",\n        \"--rm\",\n\
        \        \"-e\",\n        \"GITHUB_PERSONAL_ACCESS_TOKEN\",\n        \"ghcr.io/github/github-mcp-server:sha-7aced2b\"\
        \n      ],\n      \"env\": {\n        \"GITHUB_PERSONAL_ACCESS_TOKEN\": \"\
        ${{ secrets.GITHUB_TOKEN }}\"\n      }\n    }\n  }\n}\nEOF\n"
    - name: Run Claude Code for Issue Triage
      uses: anthropics/claude-code-base-action@v1
      timeout-minutes: 5
      with:
        prompt_file: /tmp/claude-prompts/triage-prompt.txt
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        claude_args: '--allowed-tools "Bash(gh label list),mcp__github__get_issue,mcp__github__get_issue_comments,mcp__github__update_issue,mcp__github__search_issues,mcp__github__list_issues"

          --mcp-config /tmp/mcp-config/mcp-servers.json

          '
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
